# Issue 优化助手
#
# 触发条件: 新 Issue 创建时自动运行
#
# 功能:
#   1. 自动标签: 根据 Issue 内容自动添加合适的标签
#   2. 重复检测: 检查是否存在类似的 Issue

name: Issue Optimizer

on:
  issues:
    types: [opened]

jobs:
  optimize-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Issue Optimizer
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            你是一个 GitHub Issue 优化助手。请分析以下新创建的 Issue 并执行优化任务。

            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            ISSUE TITLE: ${{ github.event.issue.title }}
            ISSUE BODY: ${{ github.event.issue.body }}

            请执行以下任务:

            ## 1. 自动标签
            根据 Issue 内容分析并添加合适的标签。仅使用以下已存在的标签:
            - `bug`: Something isn't working (程序错误或异常行为)
            - `documentation`: Improvements or additions to documentation (文档相关)
            - `duplicate`: This issue or pull request already exists (重复问题)
            - `enhancement`: New feature or request (功能增强或新需求)
            - `invalid`: This doesn't seem right (无效问题)
            - `question`: Further information is requested (问题或疑问)
            - `wontfix`: This will not be worked on (不予处理)

            使用 `gh issue edit <number> --add-label <label>` 添加标签。

            ## 2. 重复检测
            搜索现有 Issue，检查是否存在类似问题:
            - 使用 `gh issue list --search "<keywords>" --state all` 搜索
            - 如果发现可能的重复项，添加 `duplicate` 标签，并评论说明相似的 Issue 链接

          claude_args: '--allowed-tools "Bash(gh issue:*),Bash(gh search:*)"'
